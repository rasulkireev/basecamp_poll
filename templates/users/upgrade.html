{% extends 'base.html' %}
{% load static %}

{% block title %}Upgrade{% endblock %}

{% block pre_close_head %}
<script src="https://js.stripe.com/v3/"></script>
<link rel="stylesheet" href="{% static 'css/StripeElements.css' %}">
{% endblock %}

{% block content %}
<h2>Upgrade</h2>

<div>
  <form id="subscription-form">
    <div id="card-element" class="MyCardElement">
      <!-- Elements will create input elements here -->
    </div>

    <!-- We'll put the error messages in this element -->
    <div id="card-errors" role="alert"></div>
    <button id="submit" type="submit">Submit</button>
  </form>
</div>


{% endblock %}

{% block pre_close_body %}

<!-- Cory Guide -->
<script>
const stripePublicKey = "{{ STRIPE_PUBLIC_KEY }}";

document.getElementById("submit").disabled = true;
stripeElements();

function stripeElements() {
  var stripe = Stripe(stripePublicKey);

  if (document.getElementById('card-element')) {
    var elements = stripe.elements();

    var style = {
      base: {
        color: "#32325d",
        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
        fontSmoothing: "antialiased",
        fontSize: "16px",
        "::placeholder": {
          color: "#aab7c4"
        }
      },
      invalid: {
        color: "#fa755a",
        iconColor: "#fa755a"
      }
    };

    card = elements.create('card', { style: style });

    card.mount('#card-element');

    card.on('focus', function () {
      let el = document.getElementById('card-errors');
      el.classList.add('focused');
    });

    card.on('blur', function () {
      let el = document.getElementById('card-errors');
      el.classList.remove('focused');
    });

    card.on('change', function (event) {
      displayError(event);
    });
  }

  let paymentForm = document.getElementById('subscription-form');
  if (paymentForm) {

    paymentForm.addEventListener('submit', function (evt) {
      evt.preventDefault();
      changeLoadingState(true);


        // create new payment method & create subscription
      createPaymentMethod({ card });
    });
  }
}

function displayError(event) { 
 let displayError = document.getElementById('card-errors');
 if (event.error) {
   displayError.textContent = event.error.message;
 } else {
   displayError.textContent = '';
 }
}


function createPaymentMethod({ card }) {
    const customerEmail = "{{ user.email }}";
    const customerUsername = "{{ user.username }}";
    const createCustomerUrl = "{% url 'users:create_customer_and_subscription' %}";
      
    stripe
    .createPaymentMethod({
      type: 'card',
      card: card,
      billing_details: {
        name: customerUsername,
      },
    })
    .then((result) => {
      if (result.error) {
        displayError(result);
      } else {
        const paymentParams = {
          customer_email: customerEmail,
          plan_id: "prod_HdOttIJyjC3RVN",
          price_id: "price_1H4863HQF19ZH0rLuI6bgsCc",
          payment_method: result.paymentMethod.id,
      };
      fetch(createCustomerUrl, {
        method: 'post',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
        },
        credentials: 'same-origin',
        body: JSON.stringify(paymentParams),
      }).then(function(response) {
        console.log(response)
        return response.json(); 
      }).then(function(result) {
        if (result.error) {
          throw result
          // todo: check and process subscription status based on the response
        }
        return result
      }).then((result) => {
        console.log(result)
      	if (result && result.status === 'active') {
         window.location.href = "/";
      	};
      }).catch(function (error) {
        // more error handling
      });
    }
  });
}

var changeLoadingState = function(isLoading) {
	if (isLoading) {
		document.getElementById("submit").disabled = true;
		document.querySelector("#spinner").classList.remove("hidden");
		document.querySelector("#button-text").classList.add("hidden");
	} else {
		document.getElementById("submit").disabled = false;
		document.querySelector("#spinner").classList.add("hidden");
		document.querySelector("#button-text").classList.remove("hidden");
	}
};

</script>



{% endblock %}





<script>
function stripeElements() {
  stripe = Stripe('pk_test_E52Nh0gTCRpJ7h4JhuEX7BIO006LVew6GG');

  if (document.getElementById('card-element')) {
    let elements = stripe.elements();

    // Card Element styles
    let style = {
    	base: {
    		color: "#32325d",
    		fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
    		fontSmoothing: "antialiased",
    		fontSize: "16px",
    		"::placeholder": {
    			color: "#aab7c4"
    		}
    	},
    	invalid: {
    		color: "#fa755a",
    		iconColor: "#fa755a"
    	}
    };


    card = elements.create('card', { style: style });

    card.mount('#card-element');

    card.on('focus', function () {
      let el = document.getElementById('card-errors');
      el.classList.add('focused');
    });

    card.on('blur', function () {
      let el = document.getElementById('card-errors');
      el.classList.remove('focused');
    });

    card.on('change', function (event) {
      displayError(event);
    });
  }
  //we'll add payment form handling here
}
</script>